<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="..\..\bower_components/polymer/polymer.html">

<dom-module id="quiz-start">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-material {
        background: #FFF;
        padding: 12px;
      }

      .items + .items {
        border-top: 1px solid var(--divider-color);
        padding: 3px 0px;
      }

      .question {
        margin-bottom: 0px;
      }

      .choices {
        display: block;
      }

      paper-dialog {
        background: #FFF;
        position: fixed;
      }
    </style>
    <paper-material>
      <paper-button on-tap="refresh"></paper-button>
      <iron-ajax
        id="ajaxLoadQuestions"
        handle-as="json"
        last-response="{{ data }}"
        on-response="handleResponse"
        debounce-duration="300"></iron-ajax>
      
        <iron-list items="[[data]]" as="question">
          <template>
            <div class="items" data-question="{{ question.id}}" 
                               data-answer="{{ answer }}">
              <p class="question">
                <span>{{ getNumber(index) }}</span>
                <span>{{ question.text }}</span>
              </p>

              <template is="dom-if" if="{{ isTrueOrFalse(question.type) }}">
                <paper-radio-group selected="{{ answer }}">
                  <paper-radio-button name="true">true</paper-radio-button>
                  <paper-radio-button name="false">false</paper-radio-button>
                </paper-radio-group>
              </template>
              <template is="dom-if" if="{{ isMultipleChoice(question.type) }}">
                <paper-radio-group selected="{{ answer }}">
                  <template is="dom-repeat" items="{{ question.choices }}">
                    <paper-radio-button class="choices" name="{{ item.id }}">{{ item.text }}</paper-radio-button>
                  </template>
                </paper-radio-group>
              </template>
            </div>
          </template>
        </iron-list>

        <div style="text-align: center">
          <paper-button on-tap="openDlgSubmit" raised>Submit</paper-button>
        </div>
    </paper-material>

    <paper-dialog entry-animation="scale-up-animation"
                  exit-animation="fade-out-animation" id="dlgSubmit" modal>
      <h2></h2>
      <p>Are you sure you want to submit? Please review your answers before 
      proceeding.</p>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm on-tap="confirmSubmit">Confirm</paper-button>
      </div>
    </paper-dialog>

    <iron-ajax
      id="ajaxSendAnswers"
      method="post"
      handle-as="json"
      on-response="handleSendAnswers"
      last-response="{{ resultData }}"
      debounce-duration="300"></iron-ajax>

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'quiz-start',
      
      handleResponse: function() {
        console.log(this.data);
      },

      refresh: function() {
        var ajax = this.$.ajaxLoadQuestions;
        ajax.url = ['/api/student/quiz', app.quizId].join('/');
        ajax.params = {
          token: localStorage.token
        };
        ajax.generateRequest();        
      },

      getNumber: function(index) {
        return (index + 1) + '. ';
      },

      isTrueOrFalse: function(type) {
        return type == 'true_or_false';
      },

      isMultipleChoice: function(type) {
        return type == 'multiple_choice';
      },

      openDlgSubmit: function() {
        this.$.dlgSubmit.open();
      },

      confirmSubmit: function() {
        var ajax = this.$.ajaxSendAnswers;
        var items = this.querySelectorAll('.items');
        var data = [];
        for(var x=0;x<items.length;x++) {
          data.push({
            question: items[x].dataQuestion,
            answer: items[x].dataAnswer
          });
        }

        ajax.url = '/api/student/submit/quiz/' + app.quizId;
        ajax.params = {
          data: JSON.stringify(data)
        };

        ajax.generateRequest();

        // app.route = 'quiz-result';
      },

      handleSendAnswers: function() {
        console.log(this.resultData);
      }
      
    });
  })();
  </script>
</dom-module>
